{{/* 增强文件树显示 */}}
{{ $currentPage := . }}
{{ $rootSection := .Site.GetPage "section" "files" }}

{{/* 递归模板 */}}
{{ define "partials/tree-item" }}
  {{ $current := .current }}
  {{ $page := .page }}
  {{ $depth := .depth }}
  {{ $maxDepth := .maxDepth | default 3 }}
  
  {{ $isCurrent := eq $page.RelPermalink $current.RelPermalink }}
  {{ $isAncestor := $current.IsDescendant $page }}
  {{ $isExpanded := or $isCurrent $isAncestor }}
  
  <!-- 控制深度，避免太深的嵌套 -->
  {{ if lt $depth $maxDepth }}
  <div class="tree-item {{ if $isCurrent }}active{{ end }} {{ if $isAncestor }}active-path{{ end }}" 
       data-depth="{{ $depth }}"
       data-path="{{ $page.RelPermalink }}">
    <div class="tree-item-content">
      {{ if $page.IsSection }}
        {{ $children := where $page.Pages "Type" "!=" "files" }}
        {{ $hasChildren := gt (len $children) 0 }}
        
        {{ if $hasChildren }}
          <button class="tree-toggle {{ if not $isExpanded }}collapsed{{ end }}" 
                  aria-label="{{ if $isExpanded }}折叠{{ else }}展开{{ end }} {{ $page.Title }}"
                  title="{{ if $isExpanded }}折叠{{ else }}展开{{ end }}">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
              <path d="{{ if $isExpanded }}M1.5 1.5L4.5 4.5L1.5 7.5{{ else }}M4.5 1.5L7.5 4.5L4.5 7.5{{ end }}" 
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        {{ else }}
          <span class="tree-toggle-placeholder"></span>
        {{ end }}
        
        <a href="{{ $page.RelPermalink }}" class="tree-link folder {{ if $isCurrent }}current{{ end }}">
          <svg class="octicon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            {{ if $isExpanded }}
              <path fill-rule="evenodd" d="M1.75 1A1.75 1.75 0 000 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0016 13.25v-8.5A1.75 1.75 0 0014.25 3H7.5a.25.25 0 01-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75z"></path>
            {{ else }}
              <path d="M1.75 1A1.75 1.75 0 000 2.75v10.5C0 14.216.784 15 1.75 15h12.5A1.75 1.75 0 0016 13.25v-8.5A1.75 1.75 0 0014.25 3H7.5a.25.25 0 01-.2-.1l-.9-1.2C6.07 1.26 5.55 1 5 1H1.75z"></path>
            {{ end }}
          </svg>
          <span class="tree-item-name">{{ $page.Title }}</span>
          {{ if $hasChildren }}
            <span class="tree-item-count">({{ len $children }})</span>
          {{ end }}
        </a>
      {{ else }}
        <span class="tree-toggle-placeholder"></span>
        <a href="{{ $page.RelPermalink }}" class="tree-link file {{ if $isCurrent }}current{{ end }}">
          <svg class="octicon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path fill-rule="evenodd" d="M3.75 1.5a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 00.25-.25V6h-2.75A1.75 1.75 0 019 4.25V1.5H3.75zm6.75.062V4.25c0 .138.112.25.25.25h2.688a.252.252 0 00-.011-.013l-2.914-2.914a.272.272 0 00-.013-.011zM2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0113.25 16h-9.5A1.75 1.75 0 012 14.25V1.75z"></path>
          </svg>
          <span class="tree-item-name">{{ $page.Title }}</span>
        </a>
      {{ end }}
    </div>
    
    {{ if $page.IsSection }}
      {{ $children := where $page.Pages "Type" "!=" "files" }}
      {{ if gt (len $children) 0 }}
        <div class="tree-children {{ if not $isExpanded }}collapsed{{ end }}" 
             style="--depth: {{ $depth }}">
          {{ range $children }}
            {{ partial "tree-item" (dict 
              "current" $current 
              "page" . 
              "depth" (add $depth 1)
              "maxDepth" $maxDepth
            ) }}
          {{ end }}
        </div>
      {{ end }}
    {{ end }}
  </div>
  {{ end }}
{{ end }}

<!-- 渲染文件树 -->
<div class="tree-root">
  <div class="tree-header">
    <h4>文档目录</h4>
    <div class="tree-stats">
      <span id="tree-item-count">0</span> 个项目
    </div>
  </div>
  
  <div class="tree-scroll">
    {{ with $rootSection }}
      {{ range .Pages }}
        {{ partial "tree-item" (dict 
          "current" $currentPage 
          "page" . 
          "depth" 0
          "maxDepth" 5
        ) }}
      {{ end }}
    {{ end }}
  </div>
</div>