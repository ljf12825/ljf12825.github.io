{{ define "head_extra" }}
  {{ if eq .Section "blog" }}
    <link rel="stylesheet" href="{{ "css/blog.css" | relURL }}">
  {{ end }}
{{ end }}

{{ define "main" }}
<div class="blog-container">

  <!-- 中间博客内容 -->
  <main class="blog-main">
    <h1 class="page-title">{{ .Title }}</h1>

    <div class="blog-grid">
      {{ range where .Site.RegularPages "Section" "blog" }}
        <a href="{{ .RelPermalink }}" class="blog-card" data-tags="{{ with .Params.tags }}{{ delimit . "|"}}{{ end }}">
          {{ with .Params.image }}
            <img src="{{ . | relURL }}" alt="{{ $.Title }}" class="blog-thumb">
          {{ else }}
            <img src="{{ "images/gamelife.jpg" | relURL }}" alt="{{ $.Title }}" class="blog-thumb">
          {{ end }}

          <div class="blog-content">
            <h2 class="blog-title">{{ .Title }}</h2>

            <div class="blog-meta">
              <span class="date"><b>lastmodify:</b> {{ .Date.Format "2006-01-02" }}</span>
              {{ with .Params.author }}<span class="author"><b>creator:</b> {{ . }}</span>{{ end }}
              <span class="meta-line">
                {{ with .Params.categories }}{{ range $i, $cat := . }}[{{ $cat }}]{{ if lt (add $i 1) (len .) }} {{ end }}{{ end }}{{ end }}
                {{ with .Params.tags }}#{{ delimit . " #" }}{{ end }}
              </span>
            </div>


            <p class="blog-summary">
              {{ with .Params.summary }}{{ . }}{{ else }}{{ .Summary }}{{ end }}
            </p>

            <span class="read-more">ReadMore</span>
          </div>
        </a>
      {{ end }}
    </div>
  </main>

  <!-- 右侧 sidebar -->
  <aside class="sidebar-right">
    <!-- 搜索框 -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="search title & summary…">
    </div>

    <!-- 标签集合 -->
    <div class="tags-box">
      <h3>Tags</h3>
      <ul id="tagList">
        {{ $blogPages := where .Site.RegularPages "Section" "blog" }}
        {{ $tags := slice }}
        {{ range $blogPages }}
          {{ range .Params.tags }}
            {{ $tags = $tags | append . }}
          {{ end }}
        {{ end }}
        {{ range (uniq $tags | sort) }}
          <li><a href="#" class="tag-link" data-tag="{{ . }}">#{{ . }}</a></li>
        {{ end }}
      </ul>
    </div>

    <!-- 分类集合 -->
    <div class="categories-box">
      <h3>Categories</h3>
      <ul id="categoryList">
        {{ $blogPages := where .Site.RegularPages "Section" "blog" }}
        {{ $categories := slice }}
        {{ range $blogPages }}
          {{ range .Params.categories }}
            {{ $categories = $categories | append . }}
          {{ end }}
        {{ end }}
        {{ range (uniq $categories | sort) }}
          <li><a href="#" class="category-link" data-category="{{ . }}">[{{ . }}]</a></li>
        {{ end }}
      </ul>
    </div>


  </aside>

</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('searchInput');
  const tagLinks = Array.from(document.querySelectorAll('.tag-link'));
  const categoryLinks = Array.from(document.querySelectorAll('.category-link'));
  const cards = Array.from(document.querySelectorAll('.blog-card'));

  // --- 模式切换 (tags 和 categories 各自有一个 AND / OR) ---
  let tagFilterMode = "AND";
  let categoryFilterMode = "AND";

  const makeModeToggle = (labelText, defaultMode, onChange) => {
    const btn = document.createElement('button');
    btn.textContent = `${labelText}: ${defaultMode}`;
    btn.style.cursor = "pointer";
    btn.style.padding = "0.2rem 0.6rem";
    btn.style.border = "0px solid #999";
    btn.style.background = "transparent";
    btn.style.color = "white";
    btn.style.fontSize = "0.8rem";
    btn.style.marginLeft = "0.5rem";
    btn.addEventListener('mouseenter', () => { btn.style.color = "#fff"; });
    btn.addEventListener('mouseleave', () => { btn.style.color = "white"; });
    btn.addEventListener('click', () => {
      const current = btn.textContent.endsWith("AND") ? "AND" : "OR";
      const next = current === "AND" ? "OR" : "AND";
      btn.textContent = `${labelText}: ${next}`;
      onChange(next);
      filterCards();
    });
    return btn;
  };

  // 插入到 Tags 标题后
  const tagsH3 = document.querySelector('.tags-box h3');
  if (tagsH3) {
    tagsH3.style.display = "flex";
    tagsH3.style.alignItems = "center";
    tagsH3.appendChild(makeModeToggle("Mode", tagFilterMode, (m)=>tagFilterMode=m));
  }

  // 插入到 Categories 标题后
  const catsH3 = document.querySelector('.categories-box h3');
  if (catsH3) {
    catsH3.style.display = "flex";
    catsH3.style.alignItems = "center";
    catsH3.appendChild(makeModeToggle("Mode", categoryFilterMode, (m)=>categoryFilterMode=m));
  }

  // --- 数据初始化 ---
  cards.forEach(card => {
    // tags
    const rawTags = card.dataset.tags || '';
    const arrTags = rawTags.split('|').map(s => s.trim()).filter(Boolean).map(s => s.toLowerCase());
    card._tags = new Set(arrTags);

    // categories: 从 meta-line 中解析方括号 [xxx]
    const rawCats = (card.querySelector('.meta-line')?.innerText || '').toLowerCase();
    const cats = Array.from(rawCats.matchAll(/\[(.*?)\]/g)).map(m => m[1].trim());
    card._categories = new Set(cats);
  });

  const selectedTags = new Set();
  const selectedCategories = new Set();

  // --- UI 状态刷新 ---
  const refreshTagUI = () => {
    tagLinks.forEach(link => {
      const t = (link.dataset.tag || '').toLowerCase();
      link.classList.toggle('active', selectedTags.has(t));
    });
  };
  const refreshCategoryUI = () => {
    categoryLinks.forEach(link => {
      const c = (link.dataset.category || '').toLowerCase();
      link.classList.toggle('active', selectedCategories.has(c));
    });
  };

  // --- 核心过滤 ---
  const filterCards = (() => {
    let timer = null;
    return function doFilter() {
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => {
        const keyword = (searchInput.value || '').trim().toLowerCase();
        const tagsArray = Array.from(selectedTags);
        const catsArray = Array.from(selectedCategories);

        cards.forEach(card => {
          const title = (card.querySelector('.blog-title')?.innerText || '').toLowerCase();
          const summary = (card.querySelector('.blog-summary')?.innerText || '').toLowerCase();
          const matchesSearch = !keyword || title.includes(keyword) || summary.includes(keyword);

          // 标签匹配
          let matchesTags = true;
          if (tagsArray.length > 0) {
            matchesTags = (tagFilterMode === "AND")
              ? tagsArray.every(t => card._tags.has(t))
              : tagsArray.some(t => card._tags.has(t));
          }

          // 分类匹配
          let matchesCats = true;
          if (catsArray.length > 0) {
            matchesCats = (categoryFilterMode === "AND")
              ? catsArray.every(c => card._categories.has(c))
              : catsArray.some(c => card._categories.has(c));
          }

          card.style.display = (matchesSearch && matchesTags && matchesCats) ? '' : 'none';
        });
      }, 80); // debounce
    };
  })();

  // --- 点击事件绑定 ---
  tagLinks.forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      const t = (this.dataset.tag || '').toLowerCase();
      if (!t) return;
      if (selectedTags.has(t)) selectedTags.delete(t);
      else selectedTags.add(t);
      refreshTagUI();
      filterCards();
    });
  });

  categoryLinks.forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      const c = (this.dataset.category || '').toLowerCase();
      if (!c) return;
      if (selectedCategories.has(c)) selectedCategories.delete(c);
      else selectedCategories.add(c);
      refreshCategoryUI();
      filterCards();
    });
  });

  // 搜索绑定
  searchInput.addEventListener('input', filterCards);

  // 初始化
  refreshTagUI();
  refreshCategoryUI();
  filterCards();
});
</script>


{{ end }}
