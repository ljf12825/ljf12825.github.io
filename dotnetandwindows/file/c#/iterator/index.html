<!doctype html><html lang=en><head><meta name=page-kind content="page"><meta charset=UTF-8><title>Iterator</title><link rel=stylesheet href=/css/style.css><link href=https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.css rel=stylesheet><script src=https://cdn.jsdelivr.net/npm/prismjs@1/prism.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-c.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-cpp.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-csharp.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-bash.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-json.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-lua.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-python.min.js></script><script src=https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-rust.min.js></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js onload=renderMathInElement(document.body)></script><link rel=stylesheet href=/css/logsingle.css></head><body><header class=site-header><div class=container><div class=terminal-overlay aria-label=terminal-prompt><span id=typed-line></span><span class=cursor>█</span></div></div></header><nav class=topnav><div class=container><ul><li><a href=/dotnetandwindows/>★</a></li><li><a href=/dotnetandwindows/lab/>Lab</a></li><li><a href=/dotnetandwindows/log/>Log</a></li><li><a href=/dotnetandwindows/file/>File</a></li></ul></div></nav><nav id=star-nav><div id=star-header><span class="title open">>> >> >> Navigation &lt;&lt; &lt;&lt; &lt;&lt;</span>
<span class="title closed">&lt;&lt;&lt;&lt;&lt;&lt;Nav>>>>>></span></div><pre class=ascii>
+——————————————————————————————————————————————————————————————+
|                        <a class=nav-item data-path=/rightbrain/ href=/rightbrain/>RightBrain</a>                            |
|                             |                                |
|                             |     <a class=nav-item data-path=/dotnetandwindows/ href=/dotnetandwindows/>.NET-Windows</a>               |
|                             |    /                           |
|                             |   /                            |
|                             |  /                             |
|                             | /                              |
|                             |/                               |
|      <a class=nav-item data-path=/graphic/ href=/graphic/>Graphic</a> ———————————— <a class=nav-item data-path=/home/ href=/home/>Home</a> ————————————— <a class=nav-item data-path=/runtime/ href=/runtime/>Runtime</a>         |
|                            /|                                |
|                           / |                                |
|                          /  |                                |
|                         /   |       <a class=nav-item data-path=/language/ href=/language/>Language</a>                 |
|                        /    |      /                         |
|                       /     |     /                          |
|              <a class=nav-item data-path=/unixlike/ href=/unixlike/>Unix-like</a>      |    /           <a class=nav-item data-path=/project/ href=/project/>Project</a>         |
|                             |   /            <a class=nav-item data-path=/miscellaneous/ href=/miscellaneous/>Miscellaneous</a>   |
|                        <a class=nav-item data-path=/leftbrain/ href=/leftbrain/>LeftBrain</a>             <a class=nav-item data-path=/ai/ href=/ai/>AI</a>              |
+——————————————————————————————————————————————————————————————+
    </pre></nav><script defer src=/js/star-nav.js></script><script defer src=/js/site.js></script><script defer src=/js/star-active.js></script><div id=ref-window class="float-window open"><div class=float-header><span class="title open">>> >> >> Reference &lt;&lt; &lt;&lt; &lt;&lt;</span>
<span class="title closed">&lt;&lt;&lt;&lt;&lt;&lt;Ref>>>>>></span></div><div class=float-body><div class=ref-list><a href=https://www.mixamo.com/ target=_blank>Mixamo</a> |
<a href=https://opengameart.org/ target=_blank>OpenGameArt</a><p><a href=https://sharplab.io/ target=_blank>SharpLab</a> |
<a href=https://godbolt.org/ target=_blank>Compiler Explorer</a></p><p><a href="https://patorjk.com/software/taag/#p=display&f=Graffiti&t=Type+Something+&x=none&v=4&h=4&w=80&we=false" target=_blank>ASCII Graph Generator</a></p><p><a href=https://mermaid.js.org/ target=_blank>Mermaid</a></p><a href=https://www.vim.org/ target=_blank>Vim</a> | <a href=https://vimdoc.sourceforge.net/ target=_blank>Vim Manual Source</a> |
<a href=https://vimcdoc.sourceforge.net/ target=_blank>Vimcdoc</a> | <a href=https://vimcdoc.sourceforge.net/doc/help.html target=_blank>Vimdoc read online</a><p><a href=https://shields.io/ target=_blank>Shields.io</a></p><p><a href=https://emojidb.org/ target=_blank>EmojiDB</a></p><p><a href=https://cppreference.com/ target=_blank>cppreference</a> |
<a href=https://isocpp.org/ target=_blank>isocpp</a> |
<a href=https://open-std.org target=_blank>open-std</a></p><p><a href=https://cmake.com/ target=_blank>cmake.org</a></p><p><a href=https://llvm.org/ target=_blank>llvm.org</a></p><p><a href=https://www.boost.org/ target=_blank>boost.org</a></p><p><a href=https://learn.microsoft.com/en-us/dotnet/csharp/ target=_blank>Microsoft Learn</a><p><a href=https://www.lua.org/ target=_blank>lua.org</a> |
<a href=https://www.luarocks.org/ target=_blank>luarocks.org</a> |
<a href=https://www.luajit.org/ target=_blank>luajit.org</a></p><p><a href=https://docs.unity3d.com/Manual/index.html target=_blank>Unity Manual</a> |
<a href=https://docs.unity3d.com/ScriptReference/index.html target=_blank>Unity API</a></p><p><a href=https://docs.unrealengine.com/ target=_blank>Unreal Engine Docs</a></p><p><a href=https://godotengine.org target=_blank>Godot</a> |
<a href=https://docs.godotengine.org/en/stable/ target=_blank>Godot Docs</a></p><p><a href=https://z-library.sk/ target=_blank>Z-Library</a></p><p><a href=https://docs.kernel.org/ target=_blank>Linux Kernel Docs</a></p><p><a href=https://www.gnu.org/ target=_blank>GNU</a></p><a href=https://archlinux.org/ target=_blank>ArchLinux</a><p><a href=https://help.ubuntu.com/ target=_blank>Ubuntu Doc</a> |
<a href=https://ubuntu.com/server/docs target=_blank>Ubuntu Server Guide</a></p><p><a href=https://www.vulkan.org/ target=_blank>Vulkan</a> |
<a href=https://docs.vulkan.org/ target=_blank>Vulkan Docs</a></p><p><a href=https://www.opengl.org/ target=_blank>OpenGL</a> |
<a href=https://registry.khronos.org/OpenGL target=_blank>OpenGL API</a> |
<a href=https://www.khronos.org/opengl/wiki/ target=_blank>OpenGL Wiki</a></p><p><a href=https://learn.microsoft.com/en-us/windows/win32/directx target=_blank>DirectX</a></p><p><a href=https://www.realtimerendering.com/ target=_blank>Real-Time Rendering</a></p><p><a href=https://www.pbr-book.org/ target=_blank>Physically Based Rendering</a></p><p><a href=https://www.scratchapixel.com/ target=_blank>Scratchapixel</a></p><p><a href=https://learnopengl.com/ target=_blank>LearnOpenGL</a></p><p><a href=https://raytracing.github.io/ target=_blank>Ray Tracing in One Weekend</a></p><p><a href=https://www.shadertoy.com/ target=_blank>Shadertoy</a></p><p><a href=https://arxiv.org/list/cs.GR/recent target=_blank>arXiv Graphics</a></p><p><a href=https://www.siggraph.org/ target=_blank>SIGGRAPH</a> |
<a href=https://dl.acm.org/conference/siggraph target=_blank>SIGGRAPH Digital Library</a></p><p><a href=https://git-scm.com/ target=_blank>Git</a></p></div></div></div><script src=/js/ref-window.js></script><article class=single_article><div class=title>Iterator<div class=meta>Modified: 2025-06-01
| Author：ljf12825</div></div><div class=content><p>迭代器是C#中一个非常强大且优雅的特性，它极大地简化了集合枚举的实现</p><h2 id=概念>概念</h2><ul><li>核心概念：迭代器是一种方法、get访问器或运算符，它使你能够在类或集合中支持<code>foreach</code>循环</li><li>它的作用：它不会一次性返回整个集合，而是按需一次返回一个元素。这在处理大型集合或无限序列时特别有用，因为它可以节省内存</li><li>关键接口：迭代器的背后是<code>IEnumerable&lt;T></code>和<code>IEnumerator&lt;T></code>接口。有了这些迭代器后，几乎不用手动实现这些接口了</li></ul><h2 id=工作原理>工作原理</h2><p>迭代器的魔力来自于两个关键字：<code>yield return</code>和<code>yield break</code></p><ul><li><code>yield return &lt;expression></code>：向<code>foreach</code>循环“提供”下一个值，并暂停方法的执行，保留所有局部状态。当<code>foreach</code>循环下一次迭代时，该方法会从暂停的地方继续执行</li><li><code>yield break</code>：终止迭代，表示序列结束</li></ul><p>编译器会将这些包含<code>yield</code>语句的方法或属性转换成一个实现了<code>IEnumerable&lt;T></code>和<code>IEnumerator&lt;T></code>的状态机类</p><h2 id=创捷迭代器>创捷迭代器</h2><h3 id=迭代器方法返回ienumerablet>迭代器方法（返回<code>IEnumerable&lt;T></code>）</h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#ff79c6>using</span> System;
</span></span><span style=display:flex><span><span style=color:#ff79c6>using</span> System.Collections.Generic;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Program</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>void</span> Main()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 使用foreach 遍历迭代器方法</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>int</span> number <span style=color:#ff79c6>in</span> GetEvenNumbers(<span style=color:#bd93f9>10</span>))
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            Console.WriteLine(number);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 输出：0 2 4 6 8 10</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 迭代器方法，返回IEnumerable&lt;int&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt; GetEvenNumbers(<span style=color:#8be9fd>int</span> max)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i = <span style=color:#bd93f9>0</span>; i &lt;= max; i++)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 只有当 i 是偶数时，才 yield return</span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>if</span> (i % <span style=color:#bd93f9>2</span> == <span style=color:#bd93f9>0</span>)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// 在这里暂停，将 i 返回给调用者</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> i;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#6272a4>// 当 foreach 循环请求下一个元素时，从这里继续</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 方法结束相当于有一个隐式的 yield break</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=迭代器get访问器返回ienumerablet>迭代器Get访问器（返回<code>IEnumerable&lt;T></code>）</h3><p>可以为类的属性创建迭代器</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#ff79c6>using</span> System.Collections.Generic;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Zoo</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> List&lt;<span style=color:#8be9fd>string</span>&gt; _animals = <span style=color:#ff79c6>new</span> List&lt;<span style=color:#8be9fd>string</span>&gt; { <span style=color:#f1fa8c>&#34;Lion&#34;</span>, <span style=color:#f1fa8c>&#34;Tiger&#34;</span>, <span style=color:#f1fa8c>&#34;Panda&#34;</span>, <span style=color:#f1fa8c>&#34;Elephant&#34;</span> };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 迭代器属性</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> IEnumerable&lt;<span style=color:#8be9fd>string</span>&gt; Animals
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>get</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> animal <span style=color:#ff79c6>in</span> _animals)
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> animal;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 使用</span>
</span></span><span style=display:flex><span>Zoo zoo = <span style=color:#ff79c6>new</span> Zoo();
</span></span><span style=display:flex><span><span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> animal <span style=color:#ff79c6>in</span> zoo.Animals)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Console.WriteLine(animal);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=迭代器执行流程>迭代器执行流程</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>void</span> Main()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;准备调用 GetNumbers&#34;</span>);
</span></span><span style=display:flex><span>    IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt; numbers = GetNumbers(); <span style=color:#6272a4>// 1. 调用方法，但方法内的代码尚未执行！</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;准备开始 foreach 循环&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> num <span style=color:#ff79c6>in</span> numbers) <span style=color:#6272a4>// 2. 进入循环时，才第一次执行 GetNumbers 方法体</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Console.WriteLine(<span style=color:#f1fa8c>$&#34;在循环中获取了: {num}&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;循环结束&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt; GetNumbers()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;GetNumbers: 开始执行&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>1</span>; <span style=color:#6272a4>// 第一次 foreach 迭代停在这里</span>
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;GetNumbers: 返回 1 之后&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>2</span>; <span style=color:#6272a4>// 第二次 foreach 迭代停在这里</span>
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;GetNumbers: 返回 2 之后&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>3</span>; <span style=color:#6272a4>// 第三次 foreach 迭代停在这里</span>
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;GetNumbers: 返回 3 之后，方法结束&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>输出结果</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-text data-lang=text><span style=display:flex><span>准备调用 GetNumbers
</span></span><span style=display:flex><span>准备开始 foreach 循环
</span></span><span style=display:flex><span>GetNumbers: 开始执行
</span></span><span style=display:flex><span>在循环中获取了: 1
</span></span><span style=display:flex><span>GetNumbers: 返回 1 之后
</span></span><span style=display:flex><span>在循环中获取了: 2
</span></span><span style=display:flex><span>GetNumbers: 返回 2 之后
</span></span><span style=display:flex><span>在循环中获取了: 3
</span></span><span style=display:flex><span>GetNumbers: 返回 3 之后，方法结束
</span></span><span style=display:flex><span>循环结束
</span></span></code></pre></div><p><code>GetNumbers</code>方法中的代码是和<code>foreach</code>循环交替执行的</p><h3 id=底层机制>底层机制</h3><p>当编写包含<code>yield return</code>的方法时，C#编译器会进行彻底的代码重写，生成一个实现了<code>IEnumerable&lt;T></code>和<code>IEnumerator&lt;T></code>的类</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt; GetNumbers()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;开始&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;在 1 之后&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;在 2 之后&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;结束&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>编译器生成的近似代码</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#6272a4>// 编译器生成的类</span>
</span></span><span style=display:flex><span><span style=color:#50fa7b>[CompilerGenerated]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>sealed</span> <span style=color:#ff79c6>class</span> &lt;GetNumbers&gt;d__0 : IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt;, IEnumerator&lt;<span style=color:#8be9fd>int</span>&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 状态机状态</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> &lt;&gt;<span style=color:#bd93f9>1__</span>state;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> &lt;&gt;<span style=color:#bd93f9>2__</span>current;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 方法参数和局部变量</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> &lt;&gt;<span style=color:#bd93f9>3__</span>max;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> &lt;i&gt;<span style=color:#bd93f9>5__1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// IEnumerator 实现</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> IEnumerator&lt;<span style=color:#8be9fd>int</span>&gt;.Current =&gt; &lt;&gt;<span style=color:#bd93f9>2__</span>current;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>object</span> IEnumerator.Current =&gt; &lt;&gt;<span style=color:#bd93f9>2__</span>current;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#8be9fd;font-style:italic>public</span> &lt;GetNumbers&gt;d__0(<span style=color:#8be9fd>int</span> &lt;&gt;<span style=color:#bd93f9>1__</span>state)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.&lt;&gt;<span style=color:#bd93f9>1__</span>state = &lt;&gt;<span style=color:#bd93f9>1__</span>state;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>bool</span> MoveNext()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>switch</span> (&lt;&gt;<span style=color:#bd93f9>1__</span>state)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>case</span> <span style=color:#bd93f9>0</span>:
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = -<span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                Console.WriteLine(<span style=color:#f1fa8c>&#34;开始&#34;</span>);
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>2__</span>current = <span style=color:#bd93f9>1</span>;  <span style=color:#6272a4>// yield return 1</span>
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>case</span> <span style=color:#bd93f9>1</span>:
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = -<span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                Console.WriteLine(<span style=color:#f1fa8c>&#34;在 1 之后&#34;</span>);
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>2__</span>current = <span style=color:#bd93f9>2</span>;  <span style=color:#6272a4>// yield return 2</span>
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>case</span> <span style=color:#bd93f9>2</span>:
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = -<span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                Console.WriteLine(<span style=color:#f1fa8c>&#34;在 2 之后&#34;</span>);
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>2__</span>current = <span style=color:#bd93f9>3</span>;  <span style=color:#6272a4>// yield return 3</span>
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = <span style=color:#bd93f9>3</span>;
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>case</span> <span style=color:#bd93f9>3</span>:
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = -<span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                Console.WriteLine(<span style=color:#f1fa8c>&#34;结束&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// IEnumerable 实现</span>
</span></span><span style=display:flex><span>    IEnumerator&lt;<span style=color:#8be9fd>int</span>&gt; IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt;.GetEnumerator()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (&lt;&gt;<span style=color:#bd93f9>1__</span>state == -<span style=color:#bd93f9>2</span>)  <span style=color:#6272a4>// 第一次调用</span>
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            &lt;&gt;<span style=color:#bd93f9>1__</span>state = <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>this</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> &lt;GetNumbers&gt;d__0(<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>状态字段（<code>&lt;>1__state</code>）<ul><li><code>-2</code>：初始/已释放状态</li><li><code>-1</code>：执行中或已完成</li><li><code>0, 1, 2, ...</code>：对应每个<code>yield return</code>的位置</li></ul></li><li>当前值字段（<code>&lt;>2__current</code>）
存储当前要返回的元素值</li><li>局部变量字段
所有局部变量都会被提升为类的字段，以便在<code>MoveNext()</code>调用之间保持状态</li></ul><h4 id=执行流程>执行流程</h4><p>跟踪一个<code>foreach</code>循环的执行</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> num <span style=color:#ff79c6>in</span> GetNumbers())
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>$&#34;获取：{num}&#34;</span>)；
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>步骤分解：</p><ol><li>第一次调用<code>GetEnumerator()</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#6272a4>// 编译器生成</span>
</span></span><span style=display:flex><span>IEnumerator&lt;<span style=color:#8be9fd>int</span>&gt; enumerator = <span style=color:#ff79c6>new</span> &lt;GetNumbers&gt;d__0(<span style=color:#bd93f9>0</span>);
</span></span><span style=display:flex><span><span style=color:#6272a4>// state = 0, 表示从方法开头开始</span>
</span></span></code></pre></div><ol start=2><li>第一次<code>MoveNext()</code><ul><li>进入<code>case 0</code></li><li>执行<code>Console.WriteLine("开始")</code></li><li>设置<code>&lt;>2__current = 1</code></li><li>设置<code>state = 1</code>（下一个状态）</li><li>返回<code>true</code></li></ul></li><li>第一次读取<code>Current</code><ul><li><code>foreach</code>读取<code>enumerator.Current</code>得到<code>1</code></li><li>执行循环体：<code>Console.WriteLine("获取：1")</code></li></ul></li><li>第二次<code>MoveNext()</code><ul><li>进入<code>case 1</code></li><li>执行<code>Console.WriteLine("在 1 之后")</code></li><li>设置<code>&lt;>2__current = 2</code></li><li>设置<code>state = 2</code></li><li>返回<code>true</code></li></ul></li><li>依此类推&mldr;直到<code>MoveNext()</code>返回<code>false</code></li></ol><h4 id=带局部变量的复杂例子>带局部变量的复杂例子</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> IEnumerable&lt;<span style=color:#8be9fd>string</span>&gt; GetMessages(<span style=color:#8be9fd>int</span> count)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>string</span> prefix = <span style=color:#f1fa8c>&#34;Message_&#34;</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>for</span> (<span style=color:#8be9fd>int</span> i = <span style=color:#bd93f9>0</span>; i &lt; count; i++)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> prefix + i;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    Console.WriteLine(<span style=color:#f1fa8c>&#34;完成&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>编译器转换后的关键部分</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#50fa7b>[CompilerGenerated]</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd;font-style:italic>sealed</span> <span style=color:#ff79c6>class</span> &lt;GetMessages&gt;d__1 : IEnumerable&lt;<span style=color:#8be9fd>string</span>&gt;, IEnumerator&lt;<span style=color:#8be9fd>string</span>&gt;
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> &lt;&gt;<span style=color:#bd93f9>1__</span>state;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>string</span> &lt;&gt;<span style=color:#bd93f9>2__</span>current;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// 参数和局部变量变为字段</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> count;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>int</span> &lt;&gt;<span style=color:#bd93f9>3__</span>count;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>string</span> &lt;prefix&gt;<span style=color:#bd93f9>5__1</span>;  <span style=color:#6272a4>// 原局部变量 prefix</span>
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>int</span> &lt;i&gt;<span style=color:#bd93f9>5__2</span>;         <span style=color:#6272a4>// 原局部变量 i</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>private</span> <span style=color:#8be9fd>bool</span> MoveNext()
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>switch</span> (&lt;&gt;<span style=color:#bd93f9>1__</span>state)
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>case</span> <span style=color:#bd93f9>0</span>:
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = -<span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                &lt;prefix&gt;<span style=color:#bd93f9>5__1</span> = <span style=color:#f1fa8c>&#34;Message_&#34;</span>;  <span style=color:#6272a4>// 初始化局部变量</span>
</span></span><span style=display:flex><span>                &lt;i&gt;<span style=color:#bd93f9>5__2</span> = <span style=color:#bd93f9>0</span>;                <span style=color:#6272a4>// 循环初始化</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>goto</span> <span style=color:#ff79c6>case</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>case</span> <span style=color:#bd93f9>1</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>if</span> (&lt;i&gt;<span style=color:#bd93f9>5__2</span> &lt; count)
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    &lt;&gt;<span style=color:#bd93f9>2__</span>current = &lt;prefix&gt;<span style=color:#bd93f9>5__1</span> + &lt;i&gt;<span style=color:#bd93f9>5__2</span>;  <span style=color:#6272a4>// yield return</span>
</span></span><span style=display:flex><span>                    &lt;&gt;<span style=color:#bd93f9>1__</span>state = <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                    &lt;i&gt;<span style=color:#bd93f9>5__2</span>++;  <span style=color:#6272a4>// 循环计数器递增</span>
</span></span><span style=display:flex><span>                    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>true</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                &lt;&gt;<span style=color:#bd93f9>1__</span>state = -<span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>                Console.WriteLine(<span style=color:#f1fa8c>&#34;完成&#34;</span>);
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>                
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>default</span>:
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=重要的设计考虑>重要的设计考虑</h4><h5 id=为什么需要状态机>为什么需要状态机</h5><ul><li>保持执行上下文：局部变量在<code>yield</code>之间保持其值</li><li>恢复执行点：知道下一次从哪里继续执行</li><li>异常安全：正确处理<code>try-finally</code>块</li></ul><h5 id=try-finally的处理><code>try-finally</code>的处理</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt; WithFinally()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>finally</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        Console.WriteLine(<span style=color:#f1fa8c>&#34;清理&#34;</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>编译器会确保<code>finally</code>块在以下情况执行</p><ul><li>枚举完成时</li><li>调用<code>Dispose()</code>时（如<code>foreach</code>提前退出）</li><li>使用<code>using</code>语句时</li></ul><h4 id=性能考虑>性能考虑</h4><p>优点：</p><ul><li>延迟执行：只在需要时计算值</li><li>内存高效：一次只保持一个元素在内存中</li></ul><p>缺点：</p><ul><li>对象分配：每次调用迭代器方法都会创建新的状态机实例</li><li>虚调用：通过接口调用<code>MoveNext</code>和<code>Current</code></li></ul><h4 id=调试考虑>调试考虑</h4><p>虽然源代码看起来是线性的，但调试时要注意</p><ul><li>不能在某些<code>yield return</code>语句上设置断点</li><li>单步执行时会看到在<code>MoveNext()</code>中跳转</li><li>局部变量在监视窗口中的表现可能不符合直觉</li></ul><h2 id=迭代器的优点>迭代器的优点</h2><ol><li>简洁性：无需手动实现<code>IEnumerator</code>的<code>Current</code>, <code>MoveNext()</code>, <code>Reset()</code>成员</li><li>惰性求值（Lazy Evaluation）：只在需要时才计算下一个值，性能高效</li><li>状态自动管理：编译器生成的状态机自动处理局部变量和执行状态，无需关心循环到了哪一步</li><li>无限序列：可以表示无限的数学序列</li></ol><p>无限序列示例（斐波那契数列）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> IEnumerable&lt;<span style=color:#8be9fd>long</span>&gt; Fibonacci()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>long</span> a = <span style=color:#bd93f9>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>long</span> b = <span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>while</span> (<span style=color:#ff79c6>true</span>) <span style=color:#6272a4>// 无限循环！</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> a;
</span></span><span style=display:flex><span>        <span style=color:#8be9fd>long</span> temp = a;
</span></span><span style=display:flex><span>        a = b;
</span></span><span style=display:flex><span>        b = temp + b;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// 使用：只取前10个，否则会无限循环下去</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>foreach</span> (<span style=color:#8be9fd>var</span> fib <span style=color:#ff79c6>in</span> Fibonacci().Take(<span style=color:#bd93f9>10</span>))
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Console.WriteLine(fib);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=注意事项>注意事项</h2><ol><li>不允许在try-catch块中使用<code>yield return</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#6272a4>// 错误写法</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt; BadExample()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> <span style=color:#bd93f9>1</span>; <span style=color:#6272a4>// 编译错误</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// ...</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>但是，可以在<code>try</code>块中包装可能抛出异常的代码，只要<code>yield return</code>不在其中</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none><code class=language-cs data-lang=cs><span style=display:flex><span><span style=color:#6272a4>// 正确写法：将yield return 放在 try 块外部</span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> IEnumerable&lt;<span style=color:#8be9fd>int</span>&gt; GoodExample()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#8be9fd>int</span> result;
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>try</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        result = SomeOperationThatMightFail();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>catch</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        result = -<span style=color:#bd93f9>1</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>yield</span> <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以使用<code>try-finally</code>（<code>finally</code>块在迭代提前终止时也会执行）</p><ol start=2><li>返回类型必须是<code>IEnumerable</code>, <code>IEnumerable&lt;T></code>, <code>IEnumerator</code>, <code>IEnumerator&lt;T></code></li><li>不能包含 <code>ref</code>或<code>in</code>参数</li></ol></div><nav class=post-nav><a href=/dotnetandwindows/file/c%23/io/ class=hover:underline>pre: IO Stream</a>
<a href=/dotnetandwindows/file/c%23/lambda/ class=hover:underline>next: Lambda</a></nav></article><aside class=toc><h3>TOC</h3><nav id=TableOfContents><ul><li><ul><li><a href=#概念>概念</a></li><li><a href=#工作原理>工作原理</a></li><li><a href=#创捷迭代器>创捷迭代器</a><ul><li><a href=#迭代器方法返回ienumerablet>迭代器方法（返回<code>IEnumerable&lt;T></code>）</a></li><li><a href=#迭代器get访问器返回ienumerablet>迭代器Get访问器（返回<code>IEnumerable&lt;T></code>）</a></li></ul></li><li><a href=#迭代器执行流程>迭代器执行流程</a><ul><li><a href=#底层机制>底层机制</a><ul><li><a href=#执行流程>执行流程</a></li><li><a href=#带局部变量的复杂例子>带局部变量的复杂例子</a></li><li><a href=#重要的设计考虑>重要的设计考虑</a><ul><li><a href=#为什么需要状态机>为什么需要状态机</a></li><li><a href=#try-finally的处理><code>try-finally</code>的处理</a></li></ul></li><li><a href=#性能考虑>性能考虑</a></li><li><a href=#调试考虑>调试考虑</a></li></ul></li></ul></li><li><a href=#迭代器的优点>迭代器的优点</a></li><li><a href=#注意事项>注意事项</a></li></ul></li></ul></nav></aside><script defer src=/js/scrollspy.js></script><script type=module>
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
  mermaid.initialize({ 
    startOnLoad: true, theme: "default" });
</script><footer><div class=container><p>© 2026 Jeff Lee(ljf12825). All rights reserved |
<a href=https://creativecommons.org/licenses/by-nc-sa/4.0/>Article: CC BY-NC-SA 4.0</a> |
<a href=https://creativecommons.org/licenses/by-sa/4.0/>Content: CC BY-SA 4.0</a> |
<a href=https://opensource.org/licenses/MIT>Code: MIT License</a> |
<a href=/LICENSES.md>Full License</a></p></div></footer></body></html>