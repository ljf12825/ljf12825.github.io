---
title: "Terrain"
layout: single
date: 2025-06-01
categories: [笔记]
tags: [Unity, Renderer, Unity System, Unity Component]
author: "ljf12825"
---
在Unity中，Terrain是一个专门用于制作大规模、自然风格场景的强大工具  

## 什么是Terrain
Terrain是Unity提供的一个内置组件，用于在场景中创建可编辑的地形  
它由多个部分组成：  
- 地形本体（高度图控制的网格）
- 纹理涂层（地表材质贴图）
- 植被/树木/草
- 光照支持（光照贴图、探针）
- LOD和剔除

## Terrain的核心结构

| 模块                 | 功能                       |
| ------------------ | ------------------------ |
| **高度图（Heightmap）** | 决定地形的高低起伏                |
| **绘制材质（Layers）**   | 地面纹理（如草地、岩石、雪）混合涂刷       |
| **细节对象（Details）**  | 草、石头、花等低多边形细节（大量渲染优化）    |
| **树木系统（Trees）**    | 批量放置支持 LOD 的树            |
| **碰撞体**            | 自动生成地形碰撞                 |
| **光照支持**           | 支持烘焙光照图、Light Probe、反射探针 |

## Terrain in Inspector
场景中的Terrain对象一般会包含以下模块
- Terrain（主组件）
- Terrain Collider（自动附加）
- Terrain Tools（各种绘制工具）
- Terrain Settings（参数设置）

### Create Neighbor Terrains
![CreateNeighborTerrains](/assets/images/CreateNeighborTerrains.jpg)

#### 这是什么
Unity的每一个Terrain是一个地形快（chunk），当你需要构建更大的世界地图时：
> 你可以将多个地形快拼接在一起，形成一个无缝连接的大地图
`Create Neighbor Terrains`就是一个快捷工具，让你快速在上下左右形成新的Terrain，并自动设置它们之间的连接关系（Neighbor）

#### Unity会做什么
- 自动创建一个或多个相邻的Terrain GameObject
- 与当前的Terrain无缝拼接（边界贴合）
- 自动设置每个地形的Neighbor引用（主要用于LOD过渡等）

![TerrainsNeighbor](/assets/images/TerrainNeighbor.jpg)

#### 创建后的Terrain有哪些特征
- 分辨率与当前Terrain一致
- 初始高度图为空白
- 材质/Detail Layer/树/Layer并不会自动继承，需要手动复制
- 已经自动设置了`SetNeighbor`（Unity会在内部管理连接信息）

#### 为什么需要Neighbor信息
Unity Terrain在运行时做：
- LOD边界融合（避免接缝）
- 光照探针插值正确性
- 寻路/NavMesh分布

也就是说，如果你手动创建了多个Terrain，没有设置Neighbor，会出现：
- LOD切换时断裂
- 光照贴图不连续
- 草树渲染突然中断

#### Tips
多Terrain的场景通常配合：
- `Streaming`（按需加载块）
- `Runtime Stitching`（连接边界）
可以使用插件如MicroSplat/Gaia等进行多地形管理

### PaintTerrain
![PaintTerrain](/assets/images/PaintTerrain.jpg)

这是Unity Terrain系统用于手动“绘制”地形的工具，类似PS中的笔刷，但是用于三维地形，可以用它来：
- 提升/降低地形
- 涂抹纹理（比如：草、图、雪）
- 铺设草和石头（Detail）
- 放置树木（Tree）
- 设置材质混合
- 创建地形孔洞（如山洞入口）

#### Sub Tools
##### 1.Raise or Lower Terrain
> 用笔刷将地形向上或向下推动
- Bursh Size：笔刷大小（影响范围）
- Opacity：强度（提升速度）
- Target Strength：单次推拉的力量
- 可用于画山、丘陵、平原

配合`Shift`反向操作

##### 2.Set Height
> 把地形调整到某个统一的高度（例如建平台）
- 设置`Target Height`，然后绘制地形
- 适合制作建筑平台、河面、平地道路

可以使用`Flatten`一键铺平当前Terrain

##### 3.Smooth Height（平滑地形）
> 平滑地形的高低差，让地形更自然
- 常用于锐利山峰边缘平滑处理
- 减少单位移动时的突兀感

##### 4.Paint Texture（涂地表材质）
> 把不同纹理“画”到地形上，实现草地、雪地、沙漠的混合过渡
- 每个纹理时一个Terrain Layer
- Unity支持多图混合（最多8张）
- 使用笔刷方式混合地表纹理

示例层：
- Layer1：Grass
- Layer2：Dirt
- Layer3：Rock

支持自定义笔刷、混合过渡控制（Opacity）  
`Add Layer`添加纹理层，选用PBR材质（支持BaseMap、NormalMap）

##### 5.Terrain Holes
> 画出洞，让地形有缺口（可用于洞穴、地道入口）
- 类似“橡皮擦”，直接擦掉地形面片
- 可用于：
  - 做地下世界入口
  - 配合Portal、Volume、Trigger使用
默认不可通过地形下看见，需要你手动铺地板或连接其他网格模型

### Paint Trees
![PaintTrees](/assets/images/PaintTrees.jpg)

`Paint Trees`是Unity Terrain中用于批量种植树木的工具，它支持使用不同树模型的自动随机分布、缩放、选择、LOD显示等，是创建森林、山地植被的关键工具  
#### 添加树模型
点击 “Edit Trees” → “Add Tree…”：
- 在弹出的窗口中选择一个 树的 Prefab
- Unity 支持：  
  - Tree Creator 制作的树（.tree 文件）
  - SpeedTree 模型（.spm 文件）
  - 自己导入的 FBX/Prefab 模型（需带有 LOD/Collider）

要求：
- 树不能有刚体或Animator
- 树Prefab中必须包含Mesh Renderer（或SpeedTree）

#### 种树参数设置
添加好树之后，就可以开始“画树”了，主要参数如下：

| 参数                    | 作用                    |
| --------------------- | --------------------- |
| **Brush Size**        | 控制笔刷直径（影响范围）          |
| **Tree Density**      | 控制单位面积内种植的数量          |
| **Tree Height/Width** | 控制树的缩放范围（有最小和最大）      |
| **Color Variation**   | 控制颜色的随机扰动（偏红、偏绿、偏亮等）  |
| **Random Rotation**   | 勾选后自动随机 Y 轴旋转树（防止重复感） |

每画一次，就会在当前区域根据密度、大小、颜色等参数生成多个树

#### 树木渲染和性能优化
Unity的Terrain树有专门的渲染优化方案
##### Billboard（看板树）
- 当树距离相机较远时，自动变成平面图片
- 极大减少了远距离渲染负担

##### LOD支持
- 使用SpeedTree模型或LOD Group的树可自动切换模型精度
- 可自定义LOD阶段

##### GPU Instancing
- 大量相同的树会使用GPU Instancing批处理渲染
- 极大提高性能，适合森林、大面积自然场景

#### 树的碰撞
默认树时没有碰撞器的，但你可以启用碰撞
- 勾选`Tree Collider`（取决于添加的树的prefab）
- 或者在Runtime中为某些特殊树添加`Capsule Collider`等

适用于：
- 玩家可以撞到树
- 砍树系统
- 遮挡判断

#### 几种树的比较

| 工具               | 特点                           |
| ---------------- | ---------------------------- |
| **Tree Creator** | Unity 内置的老式树编辑器，支持风、LOD，效率不高，（2022版本已弃用） |
| **SpeedTree**    | 高级树木生成工具，效果好，适合中大型项目（但是商业插件） |
| **普通 Prefab 树**  | 自己做的 FBX + LOD，灵活但需优化得当      |
| **Terrain 树**    | 专为大量地形种树优化，性能最佳但不支持动画/刚体     |


![PaintDetails](/assets/images/PaintDetails.jpg)
![TerrainSetting_1](/assets/images/TerrainSetting_1.jpg)
![TerrainSetting_2](/assets/images/TerrainSetting_2.jpg)

## Terrain LOD 编写/调优

## Terrain GPU Instancing（草、树渲染优化）

## 使用Terrain Toolkit插件或Gaia等地形生成工具

## 多地形拼接、无缝过渡

## 结合导航烘焙（NavMesh + Terrain）

## Runtime地形修改（Voxel、地形破坏）

## Terrain API

